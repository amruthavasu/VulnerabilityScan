package UI;

import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.List;
import java.util.TimerTask;

import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeModel;

import start.DatabaseManager;
import start.Port;

public class PollDatabase extends TimerTask {

	DatabaseManager dbManager = new DatabaseManager();
	MainPage mainPage = MainPage.getInstance();

	@Override
	public void run() {
		// Get Hosts from DB
		boolean flag = false;
		List<String> hosts = dbManager.getHostsFromDB("SELECT * FROM HOST");
		DefaultMutableTreeNode childNode;
		DefaultTreeModel model = (DefaultTreeModel) mainPage.tree.getModel();
		DefaultMutableTreeNode root = (DefaultMutableTreeNode) model.getRoot();
		for (String host : hosts) {
			for (int i = 0; i < root.getChildCount(); i++) {
				childNode = (DefaultMutableTreeNode) root.getChildAt(i);
				if (host.equals((String) childNode.getUserObject())) {
					flag = true;
					break;
				}
			}
			if (flag == false) {
				root.add(new DefaultMutableTreeNode(host));
				model.reload();
			}
		}
		
		if (DatabaseManager.ifAllThreadsTerminated()) {
			mainPage.progressBar.setVisible(false);
		} else {
			mainPage.progressBar.setVisible(true);
		}
	}

	public List<Port> getPorts(String host) {
		List<Port> ports = new ArrayList<Port>();
		String query = "SELECT * FROM PORT WHERE IPADDR = '" + host + "'";
		try {
			ResultSet res = DatabaseManager.executeQuery(query);
			if (res != null) {
				while (res.next()) {
					Port port = new Port();
					port.setHost(host);
					port.setPortid(res.getInt("PORT_ID"));
					port.setServiceName(res.getString("SERVICE"));
					port.setState(res.getString("STATE"));
					port.setProduct(res.getString("PRODUCT"));
					port.setVersion(res.getString("VERSION"));
					ports.add(port);
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return ports;
	}

	public List<String> getVulnerabilities(String host) {
		List<String> vulnerabilities = new ArrayList<String>();
		String query = "SELECT * FROM VULNERABILITIES WHERE IPADDR = '" + host + "'";
		try {
			ResultSet res = DatabaseManager.executeQuery(query);
			if (res != null) {
				while (res.next()) {
					vulnerabilities.add(res.getString("VULN"));
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return vulnerabilities;
	}
}
